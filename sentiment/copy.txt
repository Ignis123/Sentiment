from tweepy import Stream
from tweepy import OAuthHandler
from tweepy.streaming import StreamListener
import json
import mysql.connector
import time
import sentiment_module as s

cKey = 'i0D8S1VRfHXu3VBvhtm1XXN70'
cSecret = 'omTTF24aiNHxwMv5OZOp7yrFgooW8PJofnGuMzBpWNNn7fqe17'
aToken = '4091093909-oZpHDo9Dt2Ax9K4rfCeF1Bi9EXpl0AlmV7ooW5Q'
aSecret = 'ibgEeG5NMJJ7yCqQv1jNaCtQgBRbp3H2F9tpio0jMFIeS'

conn = mysql.connector.connect(host='127.0.0.1', user='tweetuser', password='tweetpasswd', database='tweets')
myCur = conn.cursor()

class MyStreamListener(tweepy.StreamListener):
    def __init__(self):
        self.tweet_count = 0
        self.max_tweet_count = 10

    def on_data(self, data):
        while self.tweet_count < self.max_tweet_count:
            jsonData = json.loads(data)
            #if not jsonData['retweeted'] and 'RT @' not in jsonData['text']:
            tweet = jsonData["text"]
            print(tweet)
            sentiment_value, confidence = s(tweet)
            print(tweet, sentiment_value, (confidence)*100)


                #myCur.execute("INSERT INTO tweets (time, tweet, sentiment) VALUES (%s, %s, %s)",
                #          (time.time(), tweet, sentiment))

            self.tweet_count +=1
        print("Ending: count: " + str(self.tweet_count))
        #conn.commit()
        return False

    def on_status(self, status):
        if '' in status.text.lower() and 'retweeted_status' not in status:
            print(status.text)
            print(status.coordinates)

auth = tweepy.OAuthHandler(cKey, cSecret)
auth.set_access_token(aToken, aSecret)

api = tweepy.API(auth)
# api.update_status('tweepy + oauth')

#query = input('Provide a topic to search Twitter on: ')

myStreamListener = MyStreamListener()
myStream = tweepy.Stream(auth=api.auth, listener=myStreamListener)
#myStream.filter(track=[query], async=True)
myStream.filter(locations=[-180,-90,180,90], languages=["en"])#, async=True)
print("Starting")


